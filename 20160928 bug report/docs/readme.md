# C# 5以上を使った時の Inspector の挙動がおかしい

## 概要

Unity 5.5でMono C# コンパイラーのバージョンが上がったので、C# 6 (公式には未対応なことは承知していますが)を試しに使っています。
おおむね動いているんですが、特定の状況で、Hierarchy上のGameObjectにビヘイビアーを刺せなかったり、Inspector 上に表示できなかったりします。

## 背景

弊社内では、Unity 向けであっても最新のC# (現在は C# 6)を使って開発しています。
これまでは、ロジックの多くを Unity の外で書いて、DLL にビルドして、その DLL を Unity プロジェクト配下にコピーする postbuild スクリプトを使っていました。
Task クラスの .NET 3.5 向けのバックポーティング ライブラリを使えば、async/await も使えます。これで、C# の機能のうちで使えないのは dynamic くらいのはずです。
実際にリリース済みのゲームでこの方法を使っていますが、一応、これまで半年ほど実運用していて、C# 5 以上であること/Taskクラスを使っていることに起因する不具合は起こっていません。

一方、Unity 5.5 で Mono のコンパイラーのバージョンが上がりました。既定動作としては C# 4 に設定されているようですが、langversion:6 を指定してやれば普通に C# 6 が使えます。今現在、この方法で、Unity プロジェクト内でも C# 6 を使ってみる検証作業をしています。
概要の通り、おおむね動いているんですが、Inspectorの挙動がおかしいです。

## 再現手順

- mcs.rsp ファイルを用意して、-langversion:6 オプションを書き入れます
- Csharp6Namespace.cs のようなスクリプト ファイルを用意します
  - 比較のために、問題の起きないスクリプト ファイルも3つ(Csharp3Global.cs、Csharp3Namespace.cs、Csharp6Global.cs)用意しました
- 上記 Csharp6Namespace.cs を Inspector 上で見ると「No MonoBehaviour scripts in the file」メッセージが出ます
- 同、Hierarchy 上で GameObject に張り付けようとすると「Can't add script component」エラー ダイアログが出ます
- 一度このスクリプトを C# 3 の状態で書いて、GameObject に張り付けて、その後、C# 6に書き換えると「The associated script can not be loaded」になります。

(docs フォルダー以下にスクリーンショットがあります。)

要するに起きている挙動としては、

- C# 6 のコンパイル自体は問題なくできているし、MonoBehaviour ではないクラスなら全く問題なく動いている
- MonoBehaviour にして、Inspector 上に出そうとすると、C# 6 を使った場合に挙動が変
  - ただし、まったく使えないわけではなく、global 名前空間にあるクラスであればなぜか問題なく使える
  - 昔の、名前空間が使えなかった頃の Unity の状態に逆戻りしているっぽい挙動

となります。

問題を把握しているからこそC# 4しかサポートしていないのかもしれませんが、一応、動作確認結果をご報告します。
公式に「サポートする」と言えるのはだいぶ先かもしれませんが、この Inspector の問題さえ直してもらえれば非公式には C# 6 を使えそうです。